<!doctype html>
<html lang="ja">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script async src="https://static.line-scdn.net/liff/edge/2.1/sdk.js"></script>
    <title>LINE Front-end Framework - 麻雀</title>
  </head>
  <body>
    <div id="root"></div>
  </body>
  <script>
    function initializeLiff(myLiffId) {
      liff.init({
        liffId: myLiffId
      })
      .then(() => {
          initializeApp();
      })
      .catch((err) => {
          document.getElementById("liffAppContent").classList.add('hidden');
          document.getElementById("liffInitErrorMessage").classList.remove('hidden');
      });
    }
    document.addEventListener('load', () => {
      fetch('/send-id')
        .then(res => res.json())
        .then(({id}) => initializeLiff(id))
    })
    const buttonPost = document.querySelector('#post-message')
    buttonPost.addEventListener('click', function() {
      if(!liff.isInClient()) {
        console.error('Fail to initialize')
        return
      }
      const canvas = document.querySelector('canvas')
      canvas.style.background = 'white' // Default background 'transparent' turns into black on jpeg image
      const base64Image = canvas.toDataURL().replace('data:image/png;base64,', '')
      fetch('/upload', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          type: 'base64',
          image: base64Image
        })
      })
      .then(res => res.json())
      .then((imageData) => {
        liff.sendMessages([{
          'type': 'image',
          'originalContentUrl': imageData.imageUrl,
          'previewImageUrl': imageData.thumbnailUrl
        }])
      })
      .catch(function(e) {
        console.error(e)
      })
    })
  </script>
</html>
